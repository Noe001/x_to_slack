# X投稿収集・Slack通知システム 仕様書（改善版）

> **Version:** 2.1  
> **Last Updated:** 2026-02-10  
> **Status:** Draft

---

## 1. 概要

本システムは、X（旧Twitter）から特定のキーワードやハッシュタグを含む投稿を定期的に取得し、Slackチャンネルへ「日刊まとめ」として通知するバッチアプリケーションである。

### 1.1 目的

- 特定の技術トレンドや話題（例: "Rails", "AI"）を効率的にキャッチアップする
- 1日1回の通知に集約することで、業務中のノイズを減らし、情報の見落としを防ぐ

### 1.2 対象読者

- 本システムの開発者
- 運用担当者
- キーワード設定を管理する非エンジニアメンバー

---

## 2. システム構成

### 2.1 アーキテクチャ図

```
[Cloudflare Workers Cron Trigger]
        │  毎日 17:00 JST
        ▼
[Hono App (TypeScript)]
        │
        ├── keywords.json（設定読み込み）
        │
        ├──→ X API v2 (GET /2/tweets/search/recent)
        │         │
        │         ▼
        │    JSON レスポンス
        │
        ├── ビジネスロジック（フィルタ・ソート・整形）
        │
        └──→ Slack Incoming Webhook (POST)
```

### 2.2 技術スタック

| カテゴリ | 技術選定 | 理由 |
|---------|---------|------|
| 言語 | TypeScript | 型安全性により、APIレスポンスのハンドリングが堅牢になるため |
| FW | Hono | 超軽量・高速で、Cloudflare Workers向けに最適化されているため |
| インフラ | Cloudflare Workers (Paid $5/月〜) | Scheduled Events（Cron）機能が利用可能。**Freeプランでは CPU 時間制限が10msのため、Paidプラン（CPU 30s）を推奨** |
| 外部API | X API v2 (**Pay-Per-Use 従量課金**) | `search/recent` エンドポイントを使用。最低$5〜のクレジットチャージで利用開始可能（後述の料金詳細を参照） |
| 通知 | Slack Incoming Webhook | シンプルかつ無料で実装できる通知手段 |
| 設定 | JSON ファイル | 検索キーワードをコードから分離し、非エンジニアでも変更しやすくするため |

### 2.3 X API 料金体系（2026年2月〜 Pay-Per-Use）

2026年2月6日より、X API は従来の固定月額プラン（Basic $200/月、Pro $5,000/月）に加えて、**従量課金制（Pay-Per-Use）** が正式に導入された。本システムでは **Pay-Per-Use モデル** を採用する。

#### Pay-Per-Use の仕組み

- **クレジットベースのプリペイド方式:** Developer Console（console.x.com）でクレジットを事前購入し、APIリクエストごとにリアルタイムで差し引かれる
- **最低チャージ額: $5**（固定月額・契約・最低利用額は不要）
- **重複排除:** 同一リソース（同じツイートやユーザー）を24時間以内に複数回リクエストしても課金は1回分
- **失敗リクエスト:** データを返さなかったリクエストは課金対象外
- **Spending Limit:** Developer Console で上限額を設定可能（予期しない課金を防止）

#### 本システムに関連する単価

| リソース | 単価（1件あたり） | 備考 |
|---------|------------------|------|
| **Posts: Read**（投稿取得） | **$0.005** | `search/recent` で返却される投稿1件ごとに課金 |
| **Users: Read**（ユーザー情報） | **$0.010** | `expansions=author_id` 使用時に課金 |

> ※ 単価は Developer Console に表示される値が最新。上記は2026年2月時点の参考値。

#### 本システムの月間コスト試算

| 項目 | 想定値 | 月額コスト |
|------|-------|-----------|
| 投稿取得（50件/日 × 31日） | 1,550件 | $7.75 |
| ユーザー情報取得（同数） | 1,550件 | $15.50 |
| **X API 月間合計** | | **約$23.25** |
| Cloudflare Workers (Paid) | | $5 |
| **システム全体 月間合計** | | **約$28.25** |

> ※ 実際の課金額はフィルタ前の取得件数やクエリ分割の有無によって変動する。

#### レート制限

Pay-Per-Use モデルでは **旧Proプラン相当** までレート制限が緩和される。

| 項目 | 制限値 |
|------|-------|
| `search/recent` リクエスト数 | 300回/15分（ユーザー認証） |
| 月間上限 | なし（クレジット残高の範囲内） |

#### 旧プランとの比較・選択基準

| プラン | 月額 | search/recent | 適するケース |
|-------|------|--------------|-------------|
| **Pay-Per-Use（推奨）** | $5〜（従量課金） | ✅ 利用可能 | 月間数千件以下の低〜中利用量 |
| Basic（レガシー） | $200/月 | ✅ 利用可能 | 月間4〜5万アクション以上の利用 |
| Pro（レガシー） | $5,000/月 | ✅ 利用可能 | 月間100万件以上の大量利用 |
| Free（レガシー） | $0 | ✅ 利用可能 | 月間100件の読み取りのみ |

> **判断基準:** 月間合計アクション（読み取り+書き込み）が **4〜5万件以下** なら Pay-Per-Use が最も安価。本システムの想定利用量（月間約3,000件）では Pay-Per-Use が最適解。

#### 注意事項

- **旧Freeプランの実質廃止:** 新規開発者アカウントは Pay-Per-Use がデフォルト。クレジット残高が0の場合は `402 CreditsDepletedエラー` が返る
- **xAI（Grok）APIクレジット還元:** X API 利用額に応じて最大20%のxAI APIクレジットが還元される（累積$1,000以上で20%）

---

## 3. 機能要件

### 3.1 データ取得機能 (X API)

**エンドポイント:** `GET /2/tweets/search/recent`

**検索クエリ生成ロジック:**

設定ファイル（`keywords.json`）から読み込んだキーワードに対し、以下のベース条件を自動付与してクエリを構築する。

- ベース条件: `-is:retweet lang:ja`（リポスト除外、日本語のみ）
- 生成例: `(#Rails OR #Ruby OR "Next.js") -is:retweet lang:ja`

**取得パラメータ:**

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `query` | 動的生成 | キーワードをOR結合 + ベース条件 |
| `start_time` | 実行時刻 - 24時間 | ISO 8601形式 |
| `max_results` | 50（デフォルト） | 10〜100の範囲で設定可能 |
| `tweet.fields` | `created_at,public_metrics,author_id` | 必要フィールドを明示 |
| `user.fields` | `username,name` | `expansions=author_id` と併用 |
| `expansions` | `author_id` | ユーザー情報を展開取得 |

**クエリ文字数制限:** X API v2 のクエリは最大 **1,024文字**。キーワード数が多い場合はクエリを分割し、複数リクエストに分ける必要がある。その場合、リクエスト数がレート制限内に収まるよう管理すること。

### 3.2 キーワード設定管理

検索対象のキーワードは専用のJSONファイルで管理する。

**ファイル:** `src/keywords.json`

```json
{
  "version": 1,
  "global_settings": {
    "min_likes": 3,
    "max_results": 50,
    "lang": "ja"
  },
  "keywords": [
    { "term": "#Rails", "min_likes": 5 },
    { "term": "#Ruby" },
    { "term": "Next.js" },
    { "term": "Hono Framework" }
  ]
}
```

**設計意図:**

- `global_settings` でデフォルト値を定義し、キーワード単位でオーバーライド可能にする（例: Rails は人気キーワードのため、閾値を高めに設定）
- `version` フィールドにより、将来の設定フォーマット変更時に互換性を保つ
- 単純な文字列配列からオブジェクト形式に変更し、拡張性を確保

**バリデーション:**

アプリケーション起動時に以下を検証する。

- `keywords` 配列が空でないこと
- 各 `term` が空文字列でないこと
- `min_likes` が0以上の整数であること
- 生成されるクエリが1,024文字を超えないこと（超える場合はWARNログを出力して分割）

### 3.3 データ加工・フィルタリング機能

取得した投稿データに対し、以下のパイプラインで処理する。

1. **品質フィルタ:** いいね数が閾値未満（デフォルト3、キーワード個別設定で上書き可能）の投稿を除外
2. **重複排除:** 投稿本文の類似度が高いもの（例: 先頭100文字が一致）を除外し、Bot投稿や定型ツイートを排除
3. **ソート:** いいね数の降順に並び替え
4. **件数制限:** 上位N件（デフォルト10件）に絞り込み

### 3.4 通知機能 (Slack)

Slack の **Block Kit** を使用し、視認性の高いレイアウトで送信する。

**通知レイアウト:**

```
📢 本日のトピックまとめ (2026/05/23)
Keywords: #Rails, #Ruby, Next.js...
━━━━━━━━━━━━━━━━━━━━━

🥇 ❤️ 120 | 🔁 45 | @user_a
Rails 8の新しいデプロイツールが革命的すぎる件について...
🔗 https://x.com/user_a/status/xxxxx

🥈 ❤️ 85 | 🔁 20 | @user_b
初心者がハマりやすいN+1問題の解決策まとめ。
🔗 https://x.com/user_b/status/xxxxx

（以下、上位10件を表示）

━━━━━━━━━━━━━━━━━━━━━
ℹ️ 取得: 48件 → フィルタ後: 15件 → 表示: 10件
```

**投稿0件の場合:**

```
📢 本日のトピックまとめ (2026/05/23)
該当する投稿はありませんでした。
Keywords: #Rails, #Ruby, Next.js...
```

**Slack Block Kit のペイロードサイズ制限:**

Slack API は1メッセージあたり最大 **50ブロック** / **3,000文字（テキストブロック）** の制限がある。表示件数はこの制限を超えない範囲で調整すること。

---

## 4. 非機能要件

### 4.1 パフォーマンス・コスト

| 項目 | 目標値 | 備考 |
|------|-------|------|
| 1回あたり実行時間 | 5秒以内 | Workers Paid プランのCPU制限（30s）に十分余裕を持たせる |
| X API リクエスト数/実行 | 1〜3回 | クエリ分割が発生しない限り1回 |
| 月間X APIリクエスト数 | 最大93回 | 31日 × 3リクエスト |
| 月額コスト概算 | 約$28〜 | Workers Paid $5 + X API 従量課金 約$23（想定利用量ベース） |

### 4.2 セキュリティ

すべてのシークレットは **Cloudflare Secrets**（暗号化された環境変数）で管理し、コードやリポジトリにはコミットしない。

| 環境変数名 | 用途 | 設定方法 |
|-----------|------|---------|
| `X_BEARER_TOKEN` | X API 認証用 Bearer Token | `wrangler secret put X_BEARER_TOKEN` |
| `SLACK_WEBHOOK_URL` | Slack Incoming Webhook URL | `wrangler secret put SLACK_WEBHOOK_URL` |

**追加のセキュリティ要件:**

- `.dev.vars` ファイル（ローカル開発用）は `.gitignore` に含めること
- Webhook URL が外部に漏洩した場合に備え、Slack 側で Webhook の再生成手順を運用マニュアルに記載すること

### 4.3 可観測性（Observability）

| 区分 | 方法 | 内容 |
|------|------|------|
| ログ | `console.log` → Workers Logs | 実行開始/終了、取得件数、フィルタ後件数、エラー詳細 |
| アラート | Slack通知（エラー専用チャンネル） | API障害・認証エラー時にエラー内容を別チャンネルに通知 |
| メトリクス | Workers Analytics（標準） | 実行回数、実行時間、成功/失敗率 |

**ログフォーマット例:**

```
[INFO] 2026-05-23T08:00:00Z - Execution started
[INFO] 2026-05-23T08:00:01Z - Query: "(#Rails OR #Ruby) -is:retweet lang:ja"
[INFO] 2026-05-23T08:00:02Z - Fetched: 48 tweets, After filter: 15, Displayed: 10
[INFO] 2026-05-23T08:00:03Z - Slack notification sent successfully
[INFO] 2026-05-23T08:00:03Z - Execution completed in 2.8s
```

---

## 5. エラーハンドリング

全てのエラーケースについて、適切な対応を定義する。

| エラー種別 | HTTP Status | 対応 | 通知 |
|-----------|------------|------|------|
| X API レート制限 | 429 | その日の実行をスキップ。`Retry-After` ヘッダーをログ出力 | エラーチャンネルに通知 |
| X API クレジット枯渇 | 402 | 即座に終了。Developer Console でクレジットをチャージする必要がある | エラーチャンネルに通知（🚨 緊急） |
| X API 認証エラー | 401/403 | 即座に終了。トークン再発行が必要 | エラーチャンネルに通知（🚨 緊急） |
| X API サーバーエラー | 5xx | 30秒後に1回だけリトライ。失敗時はスキップ | エラーチャンネルに通知 |
| X API タイムアウト | - | 10秒でタイムアウト。1回リトライ後スキップ | エラーチャンネルに通知 |
| Slack 通知失敗 | 4xx/5xx | 2回リトライ（5秒間隔）。全て失敗の場合はログ出力のみ | ログに記録（通知手段が使えないため） |
| 設定ファイル不正 | - | バリデーションエラーとして即座に終了 | エラーチャンネルに通知 |
| 取得件数0件 | - | 正常扱い。「該当投稿なし」メッセージをSlackに送信 | 通常チャンネルに通知 |

**リトライポリシー:** 再試行はX APIの5xx・タイムアウトのみに限定し、課金増加を防ぐ。429（レート制限）・402（クレジット枯渇）では再試行しない。

---

## 6. 運用設計

### 6.1 スケジュール

| 項目 | 設定値 |
|------|-------|
| 実行頻度 | 毎日1回 |
| 実行時刻 | 17:00 JST（業務終了前を想定） |
| Cron式（UTC） | `0 8 * * *` |

**`wrangler.toml` の設定:**

```toml
[triggers]
crons = ["0 8 * * *"]
```

### 6.2 手動実行

デバッグやリカバリ用に、HTTP経由での手動実行エンドポイントも用意する。

```
GET /trigger?key={MANUAL_TRIGGER_KEY}
```

`MANUAL_TRIGGER_KEY` は環境変数で管理し、不正なアクセスを防止する。

### 6.3 デプロイ

```bash
# 本番デプロイ
wrangler deploy

# シークレット設定
wrangler secret put X_BEARER_TOKEN
wrangler secret put SLACK_WEBHOOK_URL
wrangler secret put MANUAL_TRIGGER_KEY
```

---

## 7. テスト方針

| テスト種別 | 対象 | ツール | 内容 |
|-----------|------|-------|------|
| ユニットテスト | クエリ生成、フィルタリング、ソート、Block Kit構築 | Vitest | ビジネスロジック単体のテスト |
| 統合テスト | X API → 加工 → Slack送信 | Vitest + msw | APIレスポンスをモックした結合テスト |
| E2Eテスト | 全体フロー | 手動 | ステージング環境でCronを手動実行し、Slack通知を確認 |

**テスト用の環境変数:** `.dev.vars` にテスト用Slackチャンネルの Webhook URL を設定し、本番チャンネルへの誤送信を防ぐ。

---

## 8. ディレクトリ構造

```
.
├── src/
│   ├── index.ts              # エントリーポイント（Cron Trigger / HTTP Trigger）
│   ├── keywords.json          # 検索キーワード設定ファイル
│   ├── config.ts              # 環境変数・定数・バリデーション
│   ├── services/
│   │   ├── x-client.ts        # X API クライアント（リクエスト・レスポンス処理）
│   │   ├── slack-notifier.ts  # Slack通知（Block Kit構築・送信）
│   │   └── tweet-processor.ts # フィルタリング・ソート・整形ロジック
│   ├── types/
│   │   ├── x-api.ts           # X API レスポンス型定義
│   │   ├── slack.ts           # Slack Block Kit 型定義
│   │   └── config.ts          # 設定ファイル型定義
│   └── utils/
│       ├── query-builder.ts   # 検索クエリ構築ユーティリティ
│       └── logger.ts          # 構造化ログユーティリティ
├── test/
│   ├── services/
│   │   ├── x-client.test.ts
│   │   ├── slack-notifier.test.ts
│   │   └── tweet-processor.test.ts
│   ├── utils/
│   │   └── query-builder.test.ts
│   └── mocks/
│       └── x-api-responses.ts # APIレスポンスのモックデータ
├── wrangler.toml              # Cloudflare Workers設定
├── vitest.config.ts           # テスト設定
├── tsconfig.json
├── package.json
└── README.md
```

**元の構成からの変更点:**

- `types.ts` → `types/` ディレクトリに分割（型定義の肥大化を防止）
- `utils/` ディレクトリを追加（クエリ構築・ロガーなど再利用可能なユーティリティ）
- `test/` ディレクトリを追加（テストコードの配置場所を明確化）
- サービス名をより具体的に変更（`x-service.ts` → `x-client.ts`, `slack.ts` → `slack-notifier.ts`）
- `tweet-processor.ts` を追加（フィルタ・ソートのロジックをサービスから分離）

---

## 9. 今後の拡張案（Phase 2以降）

以下は初期リリース（Phase 1）には含めないが、運用を通じて検討する項目である。

| 項目 | 概要 | 優先度 |
|------|------|-------|
| KV Storageによる永続化 | Cloudflare KV に過去の投稿IDを保存し、日をまたいだ重複排除を実現 | 中 |
| 複数チャンネル対応 | キーワードグループごとに異なるSlackチャンネルに通知 | 中 |
| Slack App化 | Incoming Webhook → Slack App に移行し、スラッシュコマンドでのキーワード管理を実現 | 低 |
| ダッシュボード | トレンドの推移をグラフ化し、Webで閲覧可能にする | 低 |
| 通知時刻のカスタマイズ | ユーザーごとに通知時刻を変更可能にする | 低 |

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | - | 初版作成 |
| 2.0 | 2026-02-10 | X APIプラン制約・代替案の追記、エラーハンドリング強化、キーワード設定の拡張、テスト方針追加、可観測性セクション追加、ディレクトリ構造の改善 |
| 2.1 | 2026-02-10 | X API 従量課金制（Pay-Per-Use、2026年2月6日正式ローンチ）の反映。旧Proプラン前提からPay-Per-Useモデルに変更。コスト試算を$5,005→約$28に修正。クレジット枯渇エラー（402）のハンドリングを追加 |
